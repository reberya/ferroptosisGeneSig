---
title: "eda_geneSignature"
author: "Ryan Rebernick"
date: "3/29/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Description:

# Load packages
```{r, warning=F, message=FALSE}

library('plyr')
library('dplyr')
library('stringr')
library('data.table')
library('tidyverse')
library('magrittr')

library('ComplexHeatmap')

```

# Find DEGs in common between 3 RNA-seq datasets
1) Pharmacological inhibition of cystine-glutamate exchange induces endoplasmic reticulum stress and ferroptosis. doi: 10.7554/eLife.02523.
2) Ferroptotic cell death triggered by conjugated linolenic acids is mediated by ACSL1. (GSE162069)
3) Ferroptosis is governed by differential regulation of transcription in liver cancer. (GSE104462) PMID: 31108460


## Load DEGs
GSE152069 and GSE104462 were re-analyzed using ensembl v97 assembly. The elife paper only provided fpkm and this was converted to counts. To convert to counts, gene length values were compressed from ensembl 67 - one of the likely assemblies used with the paper based on date. The authors from the elife paper do not deem it pertinent to include which assembly was used. Additionally, for the elife paper DEGs to broaden the number of genes, a fold change > 2 was considered significant regardless of p-value. This was done because a) they did it in the paper, and b) I was having trouble recapitulating their findings using only signfiicant genes.
```{r}

# elife 
elife <- fread('/mctp/share/users/rebernrj/projects/ferroptosisGeneSig/int/elife2014_erastin/rna_seq/elife_degs_erastin_control.txt', data.table = F)

# GSE104462 (erastin)
gse104462 <- fread('/mctp/share/users/rebernrj/projects/ferroptosisGeneSig/int/GSE104462/deseq2/GSE104462_degs_erastin_control.txt', data.table = F)

# GSE162069 (ML162)
gse162069 <- fread('/mctp/share/users/rebernrj/projects/ferroptosisGeneSig/int/GSE162069/deseq2/GSE162069_degs_erastin_control.txt', data.table = F)


```

## Filter for significant values
```{r}

# FDR 0.1
gse162069 %<>% dplyr::filter(padj <0.10) 
gse104462 %<>% dplyr::filter(padj <0.10) 

# LFC >= 1
elife %<>% dplyr::filter(abs(log2FoldChange) >= 1)

```

## Find genes in common between all data sets 
Only 9 genes in common between all data sets. I think this is becasue the GSE162* data set is crappy and does not even include the System Xc SLC genes w/in it. Unfortunately that dataset is the one with the ML162 inducer rather than erastin. Removing this dataset will reduce the applicablility of the gene signature
```{r}

# genes in common
all <- gse104462 %>%
  dplyr::filter(Row.names %in% gse162069$Row.names) %>%
  dplyr::filter(Row.names %in% elife$Row.names)

# ensure they change in the same way
## format dfs
all %<>% set_rownames(all$Row.names) %>%
  select(log2FoldChange, padj, SRR6122015:SRR6122020)
elife.sub <- elife %>% set_rownames(elife$Row.names) %>%
  select(log2FoldChange, padj, dmso_1:erastin_bme_2)
gse162069.sub <- gse162069 %>% set_rownames(gse162069$Row.names) %>%
  select(log2FoldChange, padj, SRR13125329:SRR13125333)
## merge elife and GSE104462
all <- merge(all, elife.sub, by = 0)
## select desired cols
all %<>% set_rownames(all$Row.names) %>%
  select(log2FoldChange.x, padj.x, log2FoldChange.y, padj.y, SRR6122015:SRR6122020, dmso_1:erastin_bme_2)
colnames(all)[1:4] <- c('gme104462_lfc', 'gme104462_padj', 'elife_lfc', 'elife_padj')
## merge all and GSE162069
all <- merge(all, gse162069.sub, by = 0)
## select desired cols
all %<>% set_rownames(all$Row.names) %>%
  select(gme104462_lfc, elife_lfc, log2FoldChange, gme104462_padj, elife_padj, padj, SRR6122015:erastin_bme_2, SRR13125329:SRR13125333)
colnames(all)[c(3,6)] <- c('gme162069_lfc', 'gme162069_padj')

## ensure change in same way
all %<>% dplyr::filter((elife_lfc > 0 & gme104462_lfc > 0 & gme162069_lfc > 0) | (elife_lfc < 0 & gme104462_lfc < 0 & gme162069_lfc < 0))


```

## Find genes in common between the erastin data sets
```{r}

# genes in common
erastin <- gse104462 %>%
  dplyr::filter(Row.names %in% rownames(elife.sub))

# ensure they change in the same way
## format dfs
erastin %<>% set_rownames(erastin$Row.names) %>%
  select(log2FoldChange, padj, SRR6122015:SRR6122020)

## merge
erastin <- merge(erastin, elife.sub, by = 0)
## select desired cols
erastin %<>% set_rownames(erastin$Row.names) %>%
  select(log2FoldChange.x, padj.x, log2FoldChange.y, padj.y, SRR6122015:SRR6122020, dmso_1:erastin_bme_2)
colnames(erastin)[1:4] <- c('gme104462_lfc', 'gme104462_padj', 'elife_lfc', 'elife_padj')
## ensure change in same way
erastin %<>% dplyr::filter((elife_lfc > 0 & gme104462_lfc > 0) | (elife_lfc < 0 & gme104462_lfc < 0))

```



# Lets prep the clue data so we can see how our genes of interest will look in this dataset.
Hint: It won't be clean....

## Function to clean clue data
```{r}

clean_clue <- function(clue, dose = '10 µM', time = '6 h', see_avail_opts = T){
  
  # If fxn allows for viewing avail options for timepoints/concentrations
  if (see_avail_opts == T) {
    # print available cell lines and doses
    temp <- as.data.frame(t(unname(clue[c(1,5),10:ncol(clue)])))
    colnames(temp) <- c('line', 'dose')
    print(table(temp$line, temp$dose))
    
        # print available time points and doses
    temp <- as.data.frame(t(unname(clue[5:6,10:ncol(clue)])))
    colnames(temp) <- c('dose', 'time')
    print(table(temp$dose, temp$time))
  }
  
  else {
    # keep time point of interest
    if(!is.null(time)){
      clue =  clue[, c(rep(T, 9) ,clue[6, 10:ncol(clue)] == time)]
    }
    
    # keep dose of interest
    if(!is.null(dose)){
    clue =  clue[, c(rep(T, 9) ,clue[5, 10:ncol(clue)] == dose)]
    }
    
    # separate metadata from z scores for duplicate removal
    temp <- clue[, 10:ncol(clue)] # z scores
    clue <- clue[,1:9] # meta
    
    # For duplicates, keep the replicate with a higher distil_cc_q75
    # This is the replicate consistency score (spearman correlation between replicates of lvl 4 profile)
    # https://clue.io/connectopedia/category/Analytical%20Methods
    ## order z scores by the distil_cc_q75 to facilitate removal of lower distil value
    temp <- temp[,rev(order(temp[7,]))]
    
    # recombine z scores with metadata
    clue[,10:(10+length(temp))] <- temp
    
    # Rename columns with cell line
    colnames(clue)[10:ncol(clue)] <- clue[1,10:ncol(clue)]
    
    # remove duplicate columns, keeping the one with the higher distil_cc_q75 score (higher corr between reps)
    # works because ordered by distil score above
    clue <- clue[,!duplicated(colnames(clue))]
    
    # elimiante unecessary meta data
    clue <- clue[9:length(clue$id),]
    
    # convert to numeric
    clue[10:ncol(clue)] <- apply(clue[10:ncol(clue)], 2, as.numeric)
    
    # select cols to keep for correlation
    clue %<>% dplyr::select(-id, -pr_gene_title, -pr_is_lm, -pr_is_bing, -self_correlation, -frac_self_rank, -p_value, -gene_space)
    
    return(clue)
  }
}

```

## Clean clue data from cells exposed to erastin
```{r}

# clue erastin - loaded as 2 seperate files because of export limits of clue.io
clue.erastin <- fread('/mctp/share/users/rebernrj/projects/ferroptosisGeneSig/data/clue/erastin/clue_v1.3_erastin_1.gct', skip = 2, data.table = F)
temp <- fread('/mctp/share/users/rebernrj/projects/ferroptosisGeneSig/data/clue/erastin/clue_v1.3_erastin_2.gct', skip = 2, data.table = F)

# merge clue erastin files
clue.erastin[,90:97] <- temp[,10:17]

# see options
clean_clue(clue.erastin, see_avail_opts = T)

# 5um, 6h
clue.erastin_6h_5um <- clean_clue(clue.erastin, dose = '5 µM', time = '6 h', see_avail_opts = F)

# 5um, 24h
clue.erastin_24h_5um <- clean_clue(clue.erastin, dose = '5 µM', time = '24 h', see_avail_opts = F)

# 10um, 24h
clue.erastin_24h_10um <- clean_clue(clue.erastin, dose = '10 µM', time = '24 h', see_avail_opts = F)

```

## Get specifically the KRAS WT cell lines
KRAS directly binds GPX4 to inhibit ferroptosis. Stratifying for KRAS WT cell lines would show the best responders.
```{r}

# Supp table from pmid 27821489 showing mutational status of kras for most cell lines
# converted from pdf to csv using https://www.zamzar.com/convert/pdf-to-csv/
f <- fread('/mctp/share/users/rebernrj/projects/ferroptosisGeneSig/data/pmid_ 27821489/167650_1_supp_3663141_ddk222.csv', data.table = F)

# select the cell lines with WT KRAS status
f %<>% dplyr::filter(KRAS == 'WT') %>% 
  filter(`Cell line` %in% colnames(clue.erastin_6h_5um))

# filter the clue data set so only these cell lines are used
clue.erastin_6h_5um.kras <- clue.erastin_6h_5um %>% 
  set_rownames(clue.erastin_6h_5um$pr_gene_symbol) %>%
    dplyr::select(f$`Cell line`)

```

# Genes in common from all RNA-seq dataset

## Clean all LFCs for plotting
```{r}

all.plot <- all %>%
  ## select cols
  dplyr::select(gme104462_lfc, elife_lfc, gme162069_lfc) %>%
  ## keep only genes from the clue dataset
  dplyr::filter(rownames(.) %in% rownames(clue.erastin_6h_5um.kras)) %>%
  ## sort by lfc
  dplyr::arrange(gme104462_lfc)

```

## Stratify the clue cell lines by the genes of interest
Very few of them actually represented in the clue dataset. 
```{r}

# filter clue dataset for genes of interest
clue.erastin_6h_5um.kras.sub <- clue.erastin_6h_5um.kras %>%
  dplyr::filter(rownames(.) %in% rownames(all.plot)) 

# make rownames in same order as erastin.plot
clue.erastin_6h_5um.kras.sub <- clue.erastin_6h_5um.kras.sub[order(match(rownames(clue.erastin_6h_5um.kras.sub),rownames(all.plot))),]

```

## Plot in heatmap
```{r}

library(circlize)

# color scale for RNA-seq
col_fun = colorRamp2(c(0, 4), c("white", "red"))

set.seed(11)
Heatmap(all.plot,
        show_column_dend = F,
        show_row_dend = F,
        show_row_names = F,
        column_names_gp = gpar(fontsize = 7),
        column_title_gp = gpar(fontsize = 7),
        column_title = 'All RNA-seq',
        col = col_fun
        ) +
  
Heatmap(clue.erastin_6h_5um.kras.sub,
        show_column_dend = F,
        show_row_dend = F,
        show_row_names = T,
        row_names_gp = gpar(fontsize = 5),
        column_names_gp = gpar(fontsize = 7),
        column_title_gp = gpar(fontsize = 7),
        column_title = 'Clue-Erastin w/ WT KRAS')

```


# Only the erastin datasets (The strongest datasets)

## Clean the erastin LFCs for plotting
```{r}

erastin.plot <- erastin %>%
  ## select cols
  dplyr::select(gme104462_lfc, elife_lfc) %>%
  ## keep only genes from the clue dataset
  dplyr::filter(rownames(.) %in% rownames(clue.erastin_6h_5um.kras)) %>%
  ## sort by lfc
  dplyr::arrange(gme104462_lfc)

```

## Stratify the clue cell lines by the genes of interest
Very few of them actually represented in the clue dataset. 
```{r}

# filter clue dataset for genes of interest
clue.erastin_6h_5um.kras.sub <- clue.erastin_6h_5um.kras %>%
  dplyr::filter(rownames(.) %in% rownames(erastin)) 

# make rownames in same order as erastin.plot
clue.erastin_6h_5um.kras.sub <- clue.erastin_6h_5um.kras.sub[order(match(rownames(clue.erastin_6h_5um.kras.sub),rownames(erastin.plot))),]


```

## Plot in heatmap
```{r}

set.seed(11)
Heatmap(erastin.plot,
        show_column_dend = F,
        show_row_dend = F,
        show_row_names = F,
        column_names_gp = gpar(fontsize = 7),
        row_km = 2,
        column_title = 'RNA-seq') +
  
Heatmap(clue.erastin_6h_5um.kras.sub,
        show_column_dend = F,
        show_row_dend = F,
        show_row_names = F,
        row_names_gp = gpar(fontsize = 5),
        column_names_gp = gpar(fontsize = 7),
        column_title = 'Clue-Erastin w/ WT KRAS')

```

## Try to make it prettier
Changing to factor slicing allows for clustering w/in slices. Doesn't really make a significant difference tbh.
```{r}

# number of up/down regulated genes in the erastin datasets
up <- table(erastin.plot$gme104462_lfc > 0)[2]
down <- table(erastin.plot$gme104462_lfc > 0)[1]

set.seed(11)
Heatmap(clue.erastin_6h_5um.kras.sub,
        show_column_dend = F,
        show_row_dend = F,
        show_row_names = T,
        cluster_rows = T,
        cluster_columns = T,
        clustering_method_rows = "complete",
        clustering_method_columns = "complete",
        row_names_gp = gpar(fontsize = 5),
        column_names_gp = gpar(fontsize = 7),
        column_title = 'Clue-Erastin w/ WT KRAS',
        row_split = c(rep('down', down), rep('up', up))) +
  Heatmap(erastin.plot,
        show_column_dend = F,
        show_row_dend = F,
        show_row_names = T,
        row_names_gp = gpar(fontsize = 5),
        column_names_gp = gpar(fontsize = 7),
        row_km = 2,
        column_title = 'RNA-seq')
  

```

## Add in the other RNA-seq dataset

```{r}

# GSE162069 (ML162)
gse162069 <- fread('/mctp/share/users/rebernrj/projects/ferroptosisGeneSig/int/GSE162069/deseq2/GSE162069_degs_erastin_control.txt', data.table = F)

gse162069 %<>% filter(Row.names %in% rownames(erastin.plot))
gse162069 %<>% set_rownames(gse162069$Row.names) %>%
  select(log2FoldChange, Row.names)

# make rownames in same order as erastin.plot
gse162069 <- gse162069[order(match(rownames(gse162069),rownames(erastin.plot))),]
gse162069 %<>% dplyr::select(-Row.names)
colnames(gse162069) <- 'GSE162069'

set.seed(11)
Heatmap(erastin.plot,
        show_column_dend = F,
        show_row_dend = F,
        show_row_names = F,
        column_names_gp = gpar(fontsize = 7),
        row_km = 2,
        column_title = 'RNA-seq') + 

  Heatmap(gse162069,
        show_column_dend = F,
        show_row_dend = F,
        column_names_gp = gpar(fontsize = 7)) + 
  
Heatmap(clue.erastin_6h_5um.kras.sub,
        show_column_dend = F,
        show_row_dend = F,
        show_row_names = F,
        row_names_gp = gpar(fontsize = 5),
        column_names_gp = gpar(fontsize = 7),
        column_title = 'Clue-Erastin w/ WT KRAS') 

```

## Add in the other clue.io erastin timepoints/dosages

```{r}

# 24h 5um Erastin
## filter clue dataset for genes of interest
clue.erastin_24h_5um.sub <- clue.erastin_24h_5um %>%
  set_rownames(clue.erastin_24h_5um$pr_gene_symbol) %>%
  dplyr::select(-pr_gene_symbol)
clue.erastin_24h_5um.sub %<>% dplyr::filter(rownames(.) %in% rownames(erastin)) 
## make rownames in same order as erastin.plot
clue.erastin_24h_5um.sub <- clue.erastin_24h_5um.sub[order(match(rownames(clue.erastin_24h_5um.sub),rownames(erastin.plot))),]

# 24h 10um Erastin
## filter clue dataset for genes of interest
clue.erastin_24h_10um.sub <- clue.erastin_24h_10um %>%
  set_rownames(clue.erastin_24h_10um$pr_gene_symbol) %>%
  dplyr::select(-pr_gene_symbol)
clue.erastin_24h_10um.sub %<>% dplyr::filter(rownames(.) %in% rownames(erastin)) 
## make rownames in same order as erastin.plot
clue.erastin_24h_10um.sub <- clue.erastin_24h_10um.sub[order(match(rownames(clue.erastin_24h_10um.sub),rownames(erastin.plot))),]



set.seed(11)
Heatmap(erastin.plot,
        show_column_dend = F,
        show_row_dend = F,
        show_row_names = F,
        column_names_gp = gpar(fontsize = 7),
        row_km = 2,
        column_title = 'RNA-seq',
        show_heatmap_legend = F) + 

  Heatmap(gse162069,
        show_column_dend = F,
        show_row_dend = F,
        column_names_gp = gpar(fontsize = 7),
        show_heatmap_legend = F) + 
  
Heatmap(clue.erastin_6h_5um.kras.sub,
        show_column_dend = F,
        show_row_dend = F,
        show_row_names = F,
        row_names_gp = gpar(fontsize = 5),
        column_names_gp = gpar(fontsize = 7),
        column_title = 'Clue-Erastin 5um-6h',
        show_heatmap_legend = F) +
  
Heatmap(clue.erastin_24h_5um.sub,
        show_column_dend = F,
        show_row_dend = F,
        show_row_names = F,
        column_names_gp = gpar(fontsize = 7),
        column_title = '5um-24h',
        show_heatmap_legend = F) +
  
  Heatmap(clue.erastin_24h_10um.sub,
        show_column_dend = F,
        show_row_dend = F,
        show_row_names = F,
        column_names_gp = gpar(fontsize = 7),
        column_title = '10um-24h',
        show_heatmap_legend = F)
```



# CTRP Erastin sensitivity data

## prepare ctrp data
```{r}

# load necessary ctrp data
ctrp <- fread('/mctp/share/users/rebernrj/projects/ferroptosisGeneSig/data/CTRPv2.0_2015_ctd2_ExpandedDataset/v20.data.curves_post_qc.txt', data.table = F)
exp <- fread('/mctp/share/users/rebernrj/projects/ferroptosisGeneSig/data/CTRPv2.0_2015_ctd2_ExpandedDataset/v20.meta.per_experiment.txt', data.table = F)
celltype <- fread('/mctp/share/users/rebernrj/projects/ferroptosisGeneSig/data/CTRPv2.0_2015_ctd2_ExpandedDataset/v20.meta.per_cell_line.txt', data.table = F)

# select erastin
ctrp %<>% dplyr::filter(master_cpd_id == '63578')

# Modify so each ec50 has its corresponding cell type
celltype <- merge(celltype, exp, by = 'master_ccl_id')
celltype %<>% dplyr::select(experiment_id, ccl_name)
ctrp <- merge(ctrp, celltype)
ctrp %<>% unique() 


```

## Add ec50 values to plot
```{r}

ctrp.clue <- ctrp %>% dplyr::filter(ccl_name %in% colnames(clue.erastin_6h_5um.kras.sub)) %>%
  dplyr::filter(apparent_ec50_umol <10 & apparent_ec50_umol > 0.001) %>%
  arrange(-area_under_curve)
ctrp.clue <- ctrp.clue[!duplicated(ctrp.clue$ccl_name),]

clue.erastin_6h_5um.kras.sub.ctrp <- clue.erastin_6h_5um.kras.sub %>% dplyr::select(ctrp.clue$ccl_name)

set.seed(11)
Heatmap(erastin.plot,
        show_column_dend = F,
        show_row_dend = F,
        show_row_names = F,
        column_names_gp = gpar(fontsize = 7),
        row_km = 2,
        column_title = 'RNA-seq',
        show_heatmap_legend = F) + 

  Heatmap(gse162069,
        show_column_dend = F,
        show_row_dend = F,
        column_names_gp = gpar(fontsize = 7),
        show_heatmap_legend = F) + 
  
  Heatmap(clue.erastin_6h_5um.kras.sub.ctrp,
        show_column_dend = F,
        show_row_dend = F,
        show_row_names = F,
        row_names_gp = gpar(fontsize = 5),
        column_names_gp = gpar(fontsize = 7),
        column_title = 'Clue-Erastin 5um-6h',
        show_heatmap_legend = F,
        top_annotation = HeatmapAnnotation(ec50 = ctrp.clue$apparent_ec50_umol))


```






























