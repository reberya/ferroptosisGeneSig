---
title: "eda_nbl_cohort"
author: "Ryan Rebernick"
date: "4/4/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.keep = 'all')
```


# Description:


# Load packages
```{r, warning=F, message=FALSE}

library('plyr')
library('dplyr')
library('stringr')
library('data.table')
library('tidyverse')
library('magrittr')

#BiocManager::install("singscore")
library('singscore')
install.packages("ggpubr")
library('ggpubr')
library('ggfortify')
library('cowplot')



```


# Load NBL cohort data and select samples for analysis
## Load NBL counts data and merge with metadata
17 duplicate gene names are present. These are just removed. If they are needed for any of the gene signatures they can be added to the dataset later. 
```{r}

# Load RNA-seq counts
nbl <- fread('/mctp/share/users/rebernrj/projects/ferroptosisGeneSig/data/nbl_cohort/release/ForRyan/nbl_expression-cts.csv', data.table = F)

# Remove any duplicate gene_ids so can transpose matrix
## View duplicate common gene_ids
duplicates <- nbl$gene_name[nbl$gene_name %>% duplicated()]
## remove duplicates
nbl %<>% dplyr::filter(!gene_name %in% duplicates)

# reformat the RNA-seq counts for merging with the clinical data
nbl %<>% set_rownames(nbl$gene_name) %>%
  dplyr::select(-gene_name, -gene_id) %>%
  t() %>%
  as.data.frame()

# Load the clinical data
temp <- fread('/mctp/share/users/rebernrj/projects/ferroptosisGeneSig/data/nbl_cohort/release/ForRyan/20210403_ForRyan_2021_0403_nbl_rnaseq.txt', data.table = F)

# Merge dataframes for downstream use
nbl <- merge(temp, nbl, by.x = 'rlib', by.y = 0)


```

## Select samples needed
Filtered for samples based on the following criteria:
- RNA capture method of 'capt'; ensured uniform RNA capture method
- Nonzero purity scores
- For rebiopsies of patient, took the sample with the higher purity w/in a timepoint (i.e. dxprim, dx2prim, ect)
- Eliminated samples which didn't fit the HR/LR/IR criteria (1 sample)
```{r}

# Filter for desired samples
nbl %<>% 
  ## Filter for the 'capt' RNA capture method
  dplyr::filter(r.capture == 'capt') %>%
  ## filter for nonzero purity of RNA
  dplyr::filter(purity > 0) %>%
  ## Combine timepoint refrel and relapse variables
  dplyr::mutate(timepoint = ifelse(timepoint %in% c('refrel', 'relapse'), 'rel_ref', timepoint)) %>%
  ## Generalize the timepoint variables
  dplyr::mutate(genTime = ifelse(timepoint %in% c('dxprim', 'dx2prim', 'dxmet'), 'dx', timepoint)) %>%
  ## Arrange by RNA purity for duplicate removal
  dplyr::arrange(timepoint, -purity) %>%
  ## Create pseudo variable for duplicate removal (ex. PO_3133)
  dplyr::mutate(pt.time = paste0(patient, '.', timepoint))
## show duplicates
nbl$patient[duplicated(nbl$pt.time)]
## remove duplicates based on purity, keeping highest purity
nbl <- nbl[!duplicated(nbl$pt.time),]
## Ensure samples represent only risk rated groups
nbl %<>% dplyr::filter(group %in% c('HR', 'IR', 'LR'))

# Create comparison variable for future use
nbl$comp <- ifelse(nbl$group %in% c('IR', "LR"), 'IR/LR', 'HR')

# Order dataframe cols
nbl %<>% dplyr::select(rlib:MYCN.cycle, comp, genTime, ARF5:AC106791.3)


```


# Analyze gene signatures

## Create a function to return a signature scores using 3 methods:
1) Sample scoring package - less dependence of score on other samples
https://bioconductor.org/packages/devel/bioc/vignettes/singscore/inst/doc/singscore.html#21_Sample_scoring
2) Nondirectional Summation of Z scores
- Sum the absolute values of Z scores across up and downregulated genes
3) Directional Summation of Z scores
- Sum z scores of upregulated genes + -1*(Sum of Z scores of downregulated genes)
```{r}

# nbl_df - the cleaned nbl dataframe from above
# upGenes - list of genes upregulated in gene signature
# downGenes - list of genes downregulated in gene signature
# metacols - the columns of metadata within nbl_df

calculate_signature_scores <- function(nbl_df, upGenes, downGenes, metacols = 1:30){
  
  # create temp dataframe
  cnts <- nbl_df %>% set_rownames(paste0('Sample_', 1:length(nbl_df$rlib)))
  
  # return genes not in provided gene list and remove from query
  print(paste0('Up genes not in count matrix: ', upGenes[!upGenes %in% colnames(cnts)]))
  print(paste0('Down genes not in count matrix: ', downGenes[!downGenes %in% colnames(cnts)]))
  upGenes <- upGenes[upGenes %in% colnames(cnts)]
  downGenes <- downGenes[downGenes %in% colnames(cnts)]
  
  
  # Score samples using singScore and merge
  ## score
  rankData <- cnts %>% dplyr::select(-metacols) %>%  t() %>% rankGenes()
  scoredf <- simpleScore(rankData, upSet = upGenes, downSet = downGenes)
  colnames(scoredf) <- paste0('ss.', colnames(scoredf))
  ## merge SingScore Total score with tmp df
  cnts <- merge(cnts, scoredf, by = 0)
  
  
  # Calcluate nondirectional z scores 
  temp <- apply(cnts[,c(upGenes, downGenes)], 2, scale)
  temp$nondirectional_Zsum <- rowSums(abs(temp))
  ## Add Z score to dataframe 
  cnts$nondirectional_Zsum <- temp$nondirectional_Zsum
  
  
  # Calculate directional Z scores
  ## Upregulated genes
  temp <- apply(cnts %>% dplyr::select(all_of(upGenes)), 2, scale)
  temp$upZsum <- rowSums(temp)
  ## Add Z score to dataframe 
  cnts$upZsum <- temp$upZsum
  ## Downregulated genes
  temp <- apply(cnts %>% dplyr::select(all_of(downGenes)), 2, scale)
  temp$downZsum <- rowSums(temp)
  ## Add Z score to dataframe 
  cnts$downZsum <- temp$downZsum
  
  
  # Select columns
  cnts %<>% dplyr::select(metacols, ss.TotalScore:ss.DownDispersion, nondirectional_Zsum, upZsum, downZsum)
  cnts %<>% mutate(directional_Zsum = upZsum + (downZsum * -1)) %>%
    dplyr::select(-Row.names)
  
  # Return
  return(cnts)
  
  
}

```

## Function to plot comparisons of interest
```{r}

make_plots <- function(UPGENES, DOWNGENES, comp='comp', TIMEPOINT){
  
  ####################
  # PCA PLOT by group
  ####################
  set.seed(11)
  dat <- nbl[, c('group', UPGENES, DOWNGENES)]
  a <- autoplot(dat %>% dplyr::select(-group) %>% prcomp(),
           data = dat,
           colour = 'group') +
    theme_cowplot(12)
  
  
  ####################
  # Calclulate scores
  ####################
  scores <- calculate_signature_scores(nbl_df = nbl, 
                                   upGenes = UPGENES,
                                   downGenes = DOWNGENES)
  
  ####################
  # Boxplot 
  ####################

  # select samples
  scores %<>% dplyr::filter(timepoint %in% c(TIMEPOINT))
  
  # Plot 
  b1 <- scores %>% ggplot(aes(x=comp, y=ss.TotalScore)) + 
    geom_boxplot() +
    geom_jitter(alpha=0.6, width=0.15) +
    theme_bw(base_size=16) +
    labs(subtitle="SingScore by Risk group in dxprim") +
    stat_compare_means(method = "wilcox.test")
  
  # Plot 
  b2 <- scores %>% ggplot(aes(x=comp, y=nondirectional_Zsum)) + 
    geom_boxplot() +
    geom_jitter(alpha=0.6, width=0.15) +
    theme_bw(base_size=16) +
    labs(subtitle="Nondirectional Z score by Risk group in dxprim") +
    stat_compare_means(method = "wilcox.test")
  
  # Plot 
  b3 <- scores %>% ggplot(aes(x=comp, y=directional_Zsum)) +
    geom_boxplot() +
    geom_jitter(alpha=0.6, width=0.15) +
    theme_bw(base_size=16) +
    labs(subtitle="Directional Z score by Risk group in dxprim") +
    stat_compare_means(method = "wilcox.test")
  
  return(list(a,b1,b2,b3))
  
}

```

## 306 gene signature

### Load gene signature
```{r}
sig306 <- fread('/mctp/share/users/rebernrj/projects/ferroptosisGeneSig/out/gene_signatures/erastin_clue24h_gse104462_306genes.txt',
                data.table = F)

# Upregulated
sig306_up <- sig306 %>% 
  dplyr::filter(upregulated == T) %>% 
  dplyr::select(V1) %>% unlist()

# Downregulated
sig306_dn <- sig306 %>% 
  dplyr::filter(upregulated == F) %>% 
  dplyr::select(V1) %>% unlist()


```

### Plot gene signature in boxplots/pca
```{r}

# Define comparison
nbl$comp <- ifelse(nbl$group %in% c('IR', "LR"), 'IR/LR', 'HR')

# plot PCA and boxplots
make_plots(UPGENES = sig306_up, DOWNGENES = sig306_dn, comp = 'comp', TIMEPOINT = 'dxprim')


```

















